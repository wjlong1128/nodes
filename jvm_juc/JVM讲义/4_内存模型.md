# å†…å­˜æ¨¡å‹







<hr>

[TOC]

<hr>







## 1. Javaå†…å­˜æ¨¡å‹

å¾ˆå¤šäººå°†ã€java å†…å­˜ç»“æ„ã€‘ä¸ã€java å†…å­˜æ¨¡å‹ã€‘å‚»å‚»åˆ†ä¸æ¸…ï¼Œã€java å†…å­˜æ¨¡å‹ã€‘æ˜¯ Java Memory Modelï¼ˆJMMï¼‰çš„æ„æ€ã€‚

å…³äºå®ƒçš„æƒå¨è§£é‡Šï¼Œè¯·å‚è€ƒ https://download.oracle.com/otn-pub/jcp/memory_model-1.0-pfd-spec-oth-JSpec/memory_model-1_0-pfd-spec.pdf?AuthParam=1562811549_4d4994cbd5b59d964cd2907ea22ca08b

ç®€å•çš„è¯´ï¼ŒJMM å®šä¹‰äº†ä¸€å¥—åœ¨å¤šçº¿ç¨‹è¯»å†™å…±äº«æ•°æ®æ—¶ï¼ˆæˆå‘˜å˜é‡ã€æ•°ç»„ï¼‰æ—¶ï¼Œå¯¹æ•°æ®çš„å¯è§æ€§ã€æœ‰åºæ€§ã€å’ŒåŸå­æ€§çš„è§„åˆ™å’Œä¿éšœ



### 1.1 åŸå­æ€§

åŸå­æ€§åœ¨å­¦ä¹ çº¿ç¨‹æ—¶è®²è¿‡ï¼Œä¸‹é¢æ¥ä¸ªä¾‹å­ç®€å•å›é¡¾ä¸€ä¸‹ï¼š

é—®é¢˜æå‡ºï¼Œä¸¤ä¸ªçº¿ç¨‹å¯¹åˆå§‹å€¼ä¸º 0 çš„é™æ€å˜é‡ä¸€ä¸ªåšè‡ªå¢ï¼Œä¸€ä¸ªåšè‡ªå‡ï¼Œå„åš 5000 æ¬¡ï¼Œç»“æœæ˜¯ 0 å—ï¼Ÿ



### 1.2  é—®é¢˜åˆ†æ

ä»¥ä¸Šçš„ç»“æœå¯èƒ½æ˜¯æ­£æ•°ã€è´Ÿæ•°ã€é›¶ã€‚ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸º Java ä¸­å¯¹é™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡å¹¶ä¸æ˜¯åŸå­æ“ä½œã€‚

ä¾‹å¦‚å¯¹äº `i++` è€Œè¨€ï¼ˆi ä¸ºé™æ€å˜é‡ï¼‰ï¼Œå®é™…ä¼šäº§ç”Ÿå¦‚ä¸‹çš„ JVM å­—èŠ‚ç æŒ‡ä»¤ï¼š

```java
getstatic  i 	// è·å–é™æ€å˜é‡içš„å€¼
iconst_1 		// å‡†å¤‡å¸¸é‡1
iadd 			// åŠ æ³•
putstatic  i 	// å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i
```

è€Œå¯¹åº” `i-- `ä¹Ÿæ˜¯ç±»ä¼¼ï¼š

```java
getstatic  i 	// è·å–é™æ€å˜é‡içš„å€¼
iconst_1 		// å‡†å¤‡å¸¸é‡1
isub 			// å‡æ³•
putstatic  i 	// å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i
```

è€Œ Java çš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼Œå®Œæˆé™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡éœ€è¦åœ¨ä¸»å­˜å’Œçº¿ç¨‹å†…å­˜ä¸­è¿›è¡Œæ•°æ®äº¤æ¢ï¼š

<img src= "4_å†…å­˜æ¨¡å‹.assets/image-20220928193510690.png" style="width:500px">

è€Œ Java çš„å†…å­˜æ¨¡å‹å¦‚ä¸‹ï¼Œå®Œæˆé™æ€å˜é‡çš„è‡ªå¢ï¼Œè‡ªå‡éœ€è¦åœ¨ä¸»å­˜å’Œçº¿ç¨‹å†…å­˜ä¸­è¿›è¡Œæ•°æ®äº¤æ¢ï¼šå¦‚æœæ˜¯å•çº¿ç¨‹ä»¥ä¸Š 8 è¡Œä»£ç æ˜¯é¡ºåºæ‰§è¡Œï¼ˆä¸ä¼šäº¤é”™ï¼‰æ²¡æœ‰é—®é¢˜ï¼š

```java
// å‡è®¾içš„åˆå§‹å€¼ä¸º0
getstatic  i 		// çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0
iconst_1 			// çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1
iadd 				// çº¿ç¨‹1-è‡ªå¢ çº¿ç¨‹å†…i=1
putstatic  i 		 // çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1
getstatic  i 		 // çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=1
iconst_1 			// çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1
isub 				// çº¿ç¨‹1-è‡ªå‡ çº¿ç¨‹å†…i=0
putstatic  i 		// çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=0
```

ä½†å¤šçº¿ç¨‹ä¸‹è¿™ 8 è¡Œä»£ç å¯èƒ½äº¤é”™è¿è¡Œï¼ˆä¸ºä»€ä¹ˆä¼šäº¤é”™ï¼Ÿæ€è€ƒä¸€ä¸‹ï¼‰ï¼š

å‡ºç°è´Ÿæ•°çš„æƒ…å†µï¼š

```java
// å‡è®¾içš„åˆå§‹å€¼ä¸º0
getstatic  i 		// çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0
getstatic  i 		// çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0
iconst_1 			// çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1
iadd 				// çº¿ç¨‹1-è‡ªå¢ çº¿ç¨‹å†…i=1
putstatic  i 		// çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1
iconst_1 			// çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1
isub 				// çº¿ç¨‹2-è‡ªå‡ çº¿ç¨‹å†…i=-1
putstatic  i 		// çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=-1
```

å‡ºç°æ­£æ•°çš„æƒ…å†µï¼š

```java
// å‡è®¾içš„åˆå§‹å€¼ä¸º0
getstatic  i 	// çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0
getstatic  i 	// çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0
iconst_1 		// çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1
iadd 			// çº¿ç¨‹1-è‡ªå¢ çº¿ç¨‹å†…i=1
iconst_1 		// çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1
isub 			// çº¿ç¨‹2-è‡ªå‡ çº¿ç¨‹å†…i=-1
putstatic  i 	// çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=-1
putstatic  i 	// çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1
```

> ä¸¤ä¸ªçº¿ç¨‹éƒ½æ˜¯è¯»åˆ°è‡ªå·±çš„æ“ä½œæ•°æ ˆä¸Šè¿›è¡ŒåŠ å‡å¾—å‡ºç»“æœå†å°†ç»“æœèµ‹å€¼ç»™é™æ€å˜é‡

### 1.3 è§£å†³æ–¹æ³•

`synchronized`

è¯­æ³•

```java
synchronized( å¯¹è±¡ ) {
	è¦ä½œä¸ºåŸå­æ“ä½œä»£ç 
}
```

ç”¨ `synchronized `è§£å†³å¹¶å‘é—®é¢˜ï¼š

```java
static int i = 0;
static Object obj = new Object();
public static void main(String[] args) throws InterruptedException {
    Thread t1 = new Thread(() -> {
        synchronized (obj) {
            for (int j = 0; j < 50000; j++) {
                synchronized(obj){
                   i++; 
                }
            }
        }
    });

    Thread t2 = new Thread(() -> {
        synchronized (obj) {
            for (int j = 0; j < 50000; j++) {
                 synchronized(obj){
                   i--; 
                }
            }
        }
    });
    t1.start();
    t2.start();

    t1.join();
    t2.join();
    System.out.println(i);
}
```

å¦‚ä½•ç†è§£å‘¢ï¼šä½ å¯ä»¥æŠŠ obj æƒ³è±¡æˆä¸€ä¸ªæˆ¿é—´ï¼Œçº¿ç¨‹ t1ï¼Œt2 æƒ³è±¡æˆä¸¤ä¸ªäººã€‚

å½“çº¿ç¨‹ t1 æ‰§è¡Œåˆ° synchronized(obj) æ—¶å°±å¥½æ¯” t1 è¿›å…¥äº†è¿™ä¸ªæˆ¿é—´ï¼Œå¹¶åæ‰‹é”ä½äº†é—¨ï¼Œåœ¨é—¨å†…æ‰§è¡Œcount++ ä»£ç ã€‚

è¿™æ—¶å€™å¦‚æœ t2 ä¹Ÿè¿è¡Œåˆ°äº† synchronized(obj) æ—¶ï¼Œå®ƒå‘ç°é—¨è¢«é”ä½äº†ï¼Œåªèƒ½åœ¨é—¨å¤–ç­‰å¾…ã€‚

å½“ t1 æ‰§è¡Œå®Œ synchronized{} å—å†…çš„ä»£ç ï¼Œè¿™æ—¶å€™æ‰ä¼šè§£å¼€é—¨ä¸Šçš„é”ï¼Œä» obj æˆ¿é—´å‡ºæ¥ã€‚t2 çº¿ç¨‹è¿™æ—¶æ‰å¯ä»¥è¿›å…¥ obj æˆ¿é—´ï¼Œåé”ä½é—¨ï¼Œæ‰§è¡Œå®ƒçš„ count-- ä»£ç ã€‚

> æ³¨æ„ï¼šä¸Šä¾‹ä¸­ t1 å’Œ t2 çº¿ç¨‹å¿…é¡»ç”¨ synchronized é”ä½åŒä¸€ä¸ª obj å¯¹è±¡ï¼Œå¦‚æœ t1 é”ä½çš„æ˜¯ m1 å¯¹è±¡ï¼Œt2 é”ä½çš„æ˜¯ m2 å¯¹è±¡ï¼Œå°±å¥½æ¯”ä¸¤ä¸ªäººåˆ†åˆ«è¿›å…¥äº†ä¸¤ä¸ªä¸åŒçš„æˆ¿é—´ï¼Œæ²¡æ³•èµ·åˆ°åŒæ­¥çš„æ•ˆæœã€‚



## 2. å¯è§æ€§



#### 2.1 é€€ä¸å‡ºçš„å¾ªç¯

```java
static boolean run = true;

public static void main(String[] args) throws InterruptedException {
    Thread t = new Thread(()->{
        while(run){
            // ....
            System.out.println(1);
        }
    });
    t.start();

    Thread.sleep(1000);
    run = false; // çº¿ç¨‹tä¸ä¼šå¦‚é¢„æƒ³çš„åœä¸‹æ¥
}
```



ä¸ºä»€ä¹ˆå‘¢ï¼Ÿåˆ†æä¸€ä¸‹ï¼š

1.  åˆå§‹çŠ¶æ€ï¼Œ t çº¿ç¨‹åˆšå¼€å§‹ä»ä¸»å†…å­˜è¯»å–äº† run çš„å€¼åˆ°å·¥ä½œå†…å­˜ã€‚

<img src= "4_å†…å­˜æ¨¡å‹.assets/image-20220928201653077.png" style="width:600px">

2. å› ä¸º t çº¿ç¨‹è¦é¢‘ç¹ä»ä¸»å†…å­˜ä¸­è¯»å– run çš„å€¼ï¼ŒJIT ç¼–è¯‘å™¨ä¼šå°† run çš„å€¼ç¼“å­˜è‡³è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­ï¼Œå‡å°‘å¯¹ä¸»å­˜ä¸­ run çš„è®¿é—®ï¼Œæé«˜æ•ˆç‡

<img src= "4_å†…å­˜æ¨¡å‹.assets/image-20220928201729438.png" style="width:600px">

3.  1 ç§’ä¹‹åï¼Œmain çº¿ç¨‹ä¿®æ”¹äº† run çš„å€¼ï¼Œå¹¶åŒæ­¥è‡³ä¸»å­˜ï¼Œè€Œ t æ˜¯ä»è‡ªå·±å·¥ä½œå†…å­˜ä¸­çš„é«˜é€Ÿç¼“å­˜ä¸­è¯»å–è¿™ä¸ªå˜é‡çš„å€¼ï¼Œç»“æœæ°¸è¿œæ˜¯æ—§å€¼

   <img src= "4_å†…å­˜æ¨¡å‹.assets/image-20220928201830379.png" style="width:600px">

   



#### 2.2 è§£å†³æ–¹æ³•

volatileï¼ˆæ˜“å˜å…³é”®å­—ï¼‰

å®ƒå¯ä»¥ç”¨æ¥ä¿®é¥°æˆå‘˜å˜é‡å’Œé™æ€æˆå‘˜å˜é‡ï¼Œä»–å¯ä»¥é¿å…çº¿ç¨‹ä»è‡ªå·±çš„å·¥ä½œç¼“å­˜ä¸­æŸ¥æ‰¾å˜é‡çš„å€¼ï¼Œå¿…é¡»åˆ°ä¸»å­˜ä¸­è·å–å®ƒçš„å€¼ï¼Œçº¿ç¨‹æ“ä½œ volatile å˜é‡éƒ½æ˜¯ç›´æ¥æ“ä½œä¸»å­˜



#### 2.3 å¯è§æ€§

å‰é¢ä¾‹å­ä½“ç°çš„å®é™…å°±æ˜¯å¯è§æ€§ï¼Œå®ƒä¿è¯çš„æ˜¯åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹ volatile å˜é‡çš„ä¿®æ”¹å¯¹å¦ä¸€ä¸ªçº¿ç¨‹å¯è§ï¼Œ ä¸èƒ½ä¿è¯åŸå­æ€§ï¼Œä»…ç”¨åœ¨ä¸€ä¸ªå†™çº¿ç¨‹ï¼Œå¤šä¸ªè¯»çº¿ç¨‹çš„æƒ…å†µï¼š

ä¸Šä¾‹ä»å­—èŠ‚ç ç†è§£æ˜¯è¿™æ ·çš„

```java
getstatic run 	// çº¿ç¨‹ 	t è·å– run true
getstatic run 	// çº¿ç¨‹ 	t è·å– run true
getstatic run 	// çº¿ç¨‹ 	t è·å– run true
getstatic run 	// çº¿ç¨‹ 	t è·å– run true
putstatic run 	// çº¿ç¨‹ 	main ä¿®æ”¹ run ä¸º falseï¼Œ ä»…æ­¤ä¸€æ¬¡
getstatic run 	// çº¿ç¨‹ 	t è·å– run false
```

æ¯”è¾ƒä¸€ä¸‹ä¹‹å‰æˆ‘ä»¬å°†çº¿ç¨‹å®‰å…¨æ—¶ä¸¾çš„ä¾‹å­ï¼šä¸¤ä¸ªçº¿ç¨‹ä¸€ä¸ª i++ ä¸€ä¸ª i-- ï¼Œåªèƒ½ä¿è¯çœ‹åˆ°æœ€æ–°å€¼ï¼Œä¸èƒ½è§£å†³æŒ‡ä»¤äº¤é”™

```java
// å‡è®¾içš„åˆå§‹å€¼ä¸º0
getstatic  i 	// çº¿ç¨‹1-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0
getstatic  i 	// çº¿ç¨‹2-è·å–é™æ€å˜é‡içš„å€¼ çº¿ç¨‹å†…i=0
iconst_ 1 		// çº¿ç¨‹1-å‡†å¤‡å¸¸é‡1
iadd 			// çº¿ç¨‹1-è‡ªå¢ çº¿ç¨‹å†…i=1
putstatic  i 	// çº¿ç¨‹1-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=1
iconst_1 		// çº¿ç¨‹2-å‡†å¤‡å¸¸é‡1
isub 			// çº¿ç¨‹2-è‡ªå‡ çº¿ç¨‹å†…i=-1
putstatic  i 	// çº¿ç¨‹2-å°†ä¿®æ”¹åçš„å€¼å­˜å…¥é™æ€å˜é‡i é™æ€å˜é‡i=-1
```



> **æ³¨æ„**
> synchronized è¯­å¥å—æ—¢å¯ä»¥ä¿è¯ä»£ç å—çš„åŸå­æ€§ï¼Œä¹ŸåŒæ—¶ä¿è¯ä»£ç å—å†…å˜é‡çš„å¯è§æ€§ã€‚ä½†ç¼ºç‚¹æ˜¯synchronizedæ˜¯å±äºé‡é‡çº§æ“ä½œï¼Œæ€§èƒ½ç›¸å¯¹æ›´ä½
>
> å¦‚æœåœ¨å‰é¢ç¤ºä¾‹çš„æ­»å¾ªç¯ä¸­åŠ å…¥ System.out.println() ä¼šå‘ç°å³ä½¿ä¸åŠ  volatile ä¿®é¥°ç¬¦ï¼Œçº¿ç¨‹ t ä¹Ÿèƒ½æ­£ç¡®çœ‹åˆ°å¯¹ run å˜é‡çš„ä¿®æ”¹äº†ï¼Œæƒ³ä¸€æƒ³ä¸ºä»€ä¹ˆï¼Ÿ



## 3. æœ‰åºæ€§



#### 3.1 è¯¡å¼‚çš„ç»“æœ

```java
int num = 0;
boolean ready = false;
// çº¿ç¨‹1 æ‰§è¡Œæ­¤æ–¹æ³•
public void actor1(I_Result r) {
    if(ready) {
    	r.r1 = num + num;
    } else {
        r.r1 = 1;
	}
}
// çº¿ç¨‹2 æ‰§è¡Œæ­¤æ–¹æ³•
public void actor2(I_Result r) {
    num = 2;
    ready = true;
}
```

I_Result æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œæœ‰ä¸€ä¸ªå±æ€§ r1 ç”¨æ¥ä¿å­˜ç»“æœï¼Œé—®ï¼Œå¯èƒ½çš„ç»“æœæœ‰å‡ ç§ï¼Ÿ

æœ‰åŒå­¦è¿™ä¹ˆåˆ†æ

æƒ…å†µ1ï¼šçº¿ç¨‹1 å…ˆæ‰§è¡Œï¼Œè¿™æ—¶ ready = falseï¼Œæ‰€ä»¥è¿›å…¥ else åˆ†æ”¯ç»“æœä¸º 1

æƒ…å†µ2ï¼šçº¿ç¨‹2 å…ˆæ‰§è¡Œ num = 2ï¼Œä½†æ²¡æ¥å¾—åŠæ‰§è¡Œ ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿˜æ˜¯è¿›å…¥ else åˆ†æ”¯ï¼Œç»“æœä¸º1

æƒ…å†µ3ï¼šçº¿ç¨‹2 æ‰§è¡Œåˆ° ready = trueï¼Œçº¿ç¨‹1 æ‰§è¡Œï¼Œè¿™å›è¿›å…¥ if åˆ†æ”¯ï¼Œç»“æœä¸º 4ï¼ˆå› ä¸º num å·²ç»æ‰§è¡Œè¿‡äº†ï¼‰



ä½†æˆ‘å‘Šè¯‰ä½ ï¼Œç»“æœè¿˜æœ‰å¯èƒ½æ˜¯ 0 ğŸ˜ğŸ˜ğŸ˜ï¼Œä¿¡ä¸ä¿¡å§ï¼

è¿™ç§æƒ…å†µä¸‹æ˜¯ï¼šçº¿ç¨‹2 æ‰§è¡Œ ready = trueï¼Œåˆ‡æ¢åˆ°çº¿ç¨‹1ï¼Œè¿›å…¥ if åˆ†æ”¯ï¼Œç›¸åŠ ä¸º 0ï¼Œå†åˆ‡å›çº¿ç¨‹2 æ‰§è¡Œnum = 2

ç›¸ä¿¡å¾ˆå¤šäººå·²ç»æ™•äº† ğŸ˜µğŸ˜µğŸ˜µ



è¿™ç§ç°è±¡å«åšæŒ‡ä»¤é‡æ’ï¼Œæ˜¯ JIT ç¼–è¯‘å™¨åœ¨è¿è¡Œæ—¶çš„ä¸€äº›ä¼˜åŒ–ï¼Œè¿™ä¸ªç°è±¡éœ€è¦é€šè¿‡å¤§é‡æµ‹è¯•æ‰èƒ½å¤ç°ï¼š

å€ŸåŠ© java å¹¶å‘å‹æµ‹å·¥å…· jcstress https://wiki.openjdk.java.net/display/CodeTools/jcstress

```
mvn archetype:generate -DinteractiveMode=false -
DarchetypeGroupId=org.openjdk.jcstress -DarchetypeArtifactId=jcstress-java-test-
archetype -DgroupId=org.sample -DartifactId=test -Dversion=1.0
```

åˆ›å»º maven é¡¹ç›®ï¼Œæä¾›å¦‚ä¸‹æµ‹è¯•ç±»

```java
@JCStressTest
@Outcome(id = {"1", "4"}, expect = Expect.ACCEPTABLE, desc = "ok")
@Outcome(id = "0", expect = Expect.ACCEPTABLE_INTERESTING, desc = "!!!!")
@State
public class ConcurrencyTest {
    int num = 0;
    boolean ready = false;
    
    @Actor
    public void actor1(I_Result r) {
        if(ready) {
        	r.r1 = num + num;
        } else {
            r.r1 = 1;
        }
    }
    
    @Actor
    public void actor2(I_Result r) {
        num = 2;
        ready = true;
    }
}
```

æ‰§è¡Œ

```
mvn clean install
java -jar target/jcstress.jar
```

ä¼šè¾“å‡ºæˆ‘ä»¬æ„Ÿå…´è¶£çš„ç»“æœï¼Œæ‘˜å½•å…¶ä¸­ä¸€æ¬¡ç»“æœï¼š

```
*** INTERESTING tests
	Some interesting behaviors observed. This is for the plain curiosity.
	
	2 matching test results.
		[OK] test.ConcurrencyTest
	  (JVM args: [-XX:-TieredCompilation])
	Observed state 		Occurrences 	Expectation 			Interpretation
		0 				1,729 	  	  ACCEPTABLE_INTERESTING 	!!!!
		1 				42,617,915 	  ACCEPTABLE 			  	 ok
		4 				5,146,627 	  ACCEPTABLE 				 ok
		[OK] test.ConcurrencyTest
	(JVM args: [])
	Observed state 		Occurrences 	Expectation 			Interpretation
		0 				1,652 		   ACCEPTABLE_INTERESTING 	!!!!
         1 				 46,460,657 	ACCEPTABLE 				ok
         4 				 4,571,072 		ACCEPTABLE 				ok
```

å¯ä»¥çœ‹åˆ°ï¼Œå‡ºç°ç»“æœä¸º 0 çš„æƒ…å†µæœ‰ 638 æ¬¡ï¼Œè™½ç„¶æ¬¡æ•°ç›¸å¯¹å¾ˆå°‘ï¼Œä½†æ¯•ç«Ÿæ˜¯å‡ºç°äº†ã€‚



#### 3.2 è§£å†³æ–¹æ³•

volatile ä¿®é¥°çš„å˜é‡ï¼Œå¯ä»¥ç¦ç”¨æŒ‡ä»¤é‡æ’

```java
@JCStressTest
@Outcome(id = {"1", "4"}, expect = Expect.ACCEPTABLE, desc = "ok")
@Outcome(id = "0", expect = Expect.ACCEPTABLE_INTERESTING, desc = "!!!!")
@State
public class ConcurrencyTest {
    int num = 0;
    volatile boolean ready = false;
    
    @Actor
    public void actor1(I_Result r) {
        if(ready) {
        	r.r1 = num + num;
        } else {
            r.r1 = 1;
        }
    }
    
    @Actor
    public void actor2(I_Result r) {
        num = 2;
        ready = true;
    }
}
```

ç»“æœä¸ºï¼š

```java
*** INTERESTING tests
Some interesting behaviors observed. This is for the plain curiosity.
0 matching test results.
```



## å‰©ä¸‹éƒ¨åˆ†è¯¦è§PDF

